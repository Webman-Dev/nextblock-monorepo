# Project Recap & Open Threads (Generated by Assistant)

_Last updated: 2025-10-28_

This note captures the current understanding of the **NextBlock monorepo** and the `create-nextblock-cms` scaffolding CLI. Use it as context for future sessions or threads.

---

## 1. Repository Overview

- **Monorepo root**: `D:\Websites\nextblock-monorepo`
- **Tooling**: Nx (workspace-managed), Vite for library builds, Next.js 15.x for apps.
- **Primary apps**  
  - `apps/nextblock` – the production Next.js application.  
  - `apps/create-nextblock-cms/templates/nextblock-template` – template consumed by the CLI when generating new projects. (No longer registered as an Nx project; renamed to `nextblock-template` to avoid graph conflicts.)
- **Key libraries**  
  - `libs/ui` – shared UI components (Radix-based dialog, etc.)  
  - `libs/utils` – utilities (translations provider, Supabase helpers, etc.)  
  - `libs/editor` – Tiptap Notion editor package.  
  - `libs/sdk`, `libs/db` – data access packages.
- **Docs**: `docs/` includes onboarding and architecture notes (see `monorepo-archetecture.md`, etc.).

---

## 2. CLI (`create-nextblock-cms`) Summary

- Executable: `apps/create-nextblock-cms/bin/create-nextblock-cms.js`
- Generates projects (e.g., `npm run test-create -- <name>`). Steps include:  
  1. Copy template from `apps/create-nextblock-cms/templates/nextblock-template`.  
  2. Ensure client directives and providers.  
  3. Sanitize Tailwind, Next.js, tsconfig, etc.  
  4. Install dependencies (unless `--skip-install`) and initialize git.
- Important script helpers:  
  - `ensureClientProviders` now imports `TranslationsProvider` from `@nextblock-cms/utils` and removes the old `lib/client-translations.tsx` shim.  
  - `ensureTailwindConfig` writes `tailwind.config.ts` with `content` globs for local files **and** the published UI/editor packages:
    ```ts
    content: [
      './app/**/*.{js,ts,jsx,tsx,mdx}',
      './components/**/*.{js,ts,jsx,tsx,mdx}',
      './context/**/*.{js,ts,jsx,tsx,mdx}',
      './lib/**/*.{js,ts,jsx,tsx,mdx}',
      './node_modules/@nextblock-cms/ui/**/*.{js,ts,jsx,tsx}',
      './node_modules/@nextblock-cms/editor/**/*.{js,ts,jsx,tsx}',
    ]
    ```
- Template sync command: `npm run sync:create-nextblock-cms` (copies the latest `apps/nextblock` files into template).
- Generated Tailwind config lives in new project root (`tailwind.config.ts`) and should match the snippet above.

---

## 3. Recent Changes / Fixes

### 3.1 Utils Server Module
- `libs/utils/src/server.ts` no longer starts with `"use server"` to avoid Next.js server-action constraints when re-exporting helpers.

### 3.2 Dialog Centering
- Updated `libs/ui/src/lib/dialog.tsx` to wrap content in a flex-centered overlay. Monorepo app uses it successfully. (Generated projects still need Tailwind content globs above to avoid class purging.)

### 3.3 Translations Provider
- Removed legacy provider shim from template & CLI. All projects now import from `@nextblock-cms/utils`.  
- Ensure `.env` includes Supabase keys; middleware throws otherwise (`apps/nextblock/middleware.ts`). New scaffolds must populate `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, etc.

### 3.4 Nx Project Graph
- Template `project.json` reduced to:
  ```json
  {
    "name": "nextblock-template",
    "projectType": "application",
    "root": "apps/create-nextblock-cms/templates/nextblock-template",
    "sourceRoot": "apps/create-nextblock-cms/templates/nextblock-template",
    "targets": {}
  }
  ```
  Prevents `nx serve nextblock` collisions.

### 3.5 Published Packages
- `@nextblock-cms/utils@0.0.11` published with new exports (`dist/libs/utils`). `@nextblock-cms/ui` still local but compiles via Vite. Ensure `npm pack` is used when testing locally or publish updated versions before distributing CLI.

---

## 4. Remaining Issues / Open Questions

1. **Tailwind classes in generated projects** – After adding the new globs, confirm `npm run dev` in the generated app picks them up (the screenshot indicates styling still missing). Possible next checks:  
   - Clear Next/Tailwind caches (`rm -rf .next`, restart).  
   - Ensure both `tailwind.config.ts` and `postcss.config.js` are loaded (check `globals.css` import order).  
   - Inspect final CSS for `.fixed.inset-0.flex.items-center.justify-center` class compiled from `@nextblock-cms/ui`.  
2. **Notion Editor theme** – confirm `libs/editor/src/styles/editor.css` is bundled in generated project (added via CLI using `ensureEditorStyles`). Verify the generated `app/globals.css` contains `@import '@nextblock-cms/editor/styles/editor.css';`.  
3. **Supabase middleware** – Document fallback behavior (currently throws; consider soft warning for scaffold).  
4. **Package publishing workflow** – For reproducibility, script `npm pack` step in docs or CLI.  
5. **Tests / QA** – No automated checks on generated project aside from manual `npm run dev`. Might add smoke test command.  
6. **Docs** – Future updates should mention the workspace-vs-generated divergence (UI centered when using workspace alias & Tailwind config).  

---

## 5. Useful File References

- `apps/create-nextblock-cms/bin/create-nextblock-cms.js` – CLI entry point.
- `apps/create-nextblock-cms/scripts/sync-template.js` – sync template + ensure client provider/tailwind sanitizers.
- `apps/nextblock/app/providers.tsx` – reference provider wiring.
- `libs/ui/src/lib/dialog.tsx` – new centered dialog implementation.
- `libs/utils/src/server.ts` & `lib/server-utils.ts` – server helpers.
- `libs/editor/src/lib/NotionEditor.tsx` – modal that relies on Tailwind/animations (check generated CSS).

---

## 6. Quick Commands

- `nx serve nextblock` – run monorepo app.
- `npm run sync:create-nextblock-cms` – refresh template from monorepo app.
- `npm run test-create -- <name>` – scaffold new project (uses published package versions).
- `npm run dev` (in generated project) – start Next.js dev server.
- `npx vite build --config libs/ui/vite.config.ts` – rebuild UI library.
- `npx vite build --config libs/utils/vite.config.ts` – rebuild utils library.

---

## 7. Next Steps Checklist

- [ ] Confirm Tailwind glob change fixes modal centering in generated project (rebuild CSS, restart dev server).  
- [ ] Validate editor styles import in scaffold (`app/globals.css`).  
- [ ] Decide on middleware fallback for missing Supabase envs.  
- [ ] Document or automate publishing flow for UI package (`npm pack`, `npm publish`).  
- [ ] Consider adding smoke test script for generated projects.

---

_Keep this doc updated when any core behavior changes (CLI, libs, Next app)._
